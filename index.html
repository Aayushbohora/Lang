<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>NexiLang IDE</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Fira Sans", monospace;
           background:#0f1720; color:#e6eef8; margin:0; padding:20px; }
    .container { max-width:1000px; margin:0 auto; }
    h1 { margin:0 0 12px 0; }
    textarea { width:100%; height:320px; padding:12px; font-family:monospace; font-size:15px;
               background:#071022; color:#dbeafe; border-radius:8px; border:1px solid #123; resize:vertical; }
    #run { margin-top:12px; padding:10px 18px; border-radius:8px; border:none;
          background: linear-gradient(90deg,#06b6d4,#3b82f6); color:#012; font-weight:700; cursor:pointer; }
    #output { margin-top:16px; background:#001219; padding:12px; min-height:120px; border-radius:8px;
             color:#bbf7d0; white-space:pre-wrap; border:1px solid #023; }
    label { font-size:13px; color:#9fb3c8; }
    .small { font-size:13px; color:#9fb3c8; margin-top:6px; }
    .prompt { display:flex; gap:8px; align-items:center; margin-bottom:8px; }
    .modal { position:fixed; inset:0; display:flex; align-items:center; justify-content:center; }
    .modal .box { background:#04293a; padding:18px; border-radius:8px; border:1px solid #045; color:#e6eef8; width:90%; max-width:540px; }
    .modal input { width:100%; padding:8px; margin-top:8px; border-radius:6px; border:1px solid #034; background:#021827; color:#dff; }
    .modal .btn { margin-top:10px; padding:8px 14px; border-radius:6px; border:none; background:#06b6d4; color:#002; cursor:pointer; font-weight:700; }
  </style>
</head>
<body>
  <div class="container">
    <h1>NexiLang IDE (full features)</h1>
    <label for="code">Code</label>
    <textarea id="code" spellcheck="false"># Example NexiLang program
nex name = "Guest"
lang("Hello, welcome!")
lang("What's your name?")
lang(put("Please enter name:"))
nex i = 0
loop 3 {
  lang("Loop iteration:")
  lang(i)
  nex i = i + 1
}
# while style loop example:
nex cnt = 0
loop (cnt < 2) {
  lang("while-style cnt=")
  lang(cnt)
  nex cnt = cnt + 1
}
ifnex (1 == 1) {
  lang("if works")
} nexlf (1 == 2) {
  lang("no")
} nexls {
  lang("else reached")
}
</textarea>

    <div style="display:flex;gap:12px;align-items:center">
      <button id="run">Run</button>
      <div class="small">Use <code>nex</code> for assignment, <code>lang()</code> to print, <code>put("...")</code> for input.</div>
    </div>

    <label class="small" style="margin-top:12px">Output</label>
    <div id="output">(output will appear here)</div>
  </div>

  <!-- modal for put() prompts -->
  <div id="modalRoot" style="display:none;"></div>

<script>
/*
Frontend strategy for put("..."):
  - Before sending code to server, find all put("...") calls left-to-right.
  - For each, prompt the user using a modal, collect answers, and replace the put("...") call
    in the code with a literal string (properly escaped), e.g. "Alice".
  - Then send the transformed code to /run.
This keeps server stateless and allows interactive prompts.
*/

function escapeForCode(s) {
  return '"' + s.replace(/\\/g,'\\\\').replace(/"/g,'\\"') + '"';
}

async function askSequentially(prompts) {
  // returns array of answers
  const answers = [];
  for (const p of prompts) {
    const ans = await showPrompt(p);
    answers.push(ans);
  }
  return answers;
}

function showPrompt(promptText) {
  return new Promise(resolve => {
    const root = document.getElementById('modalRoot');
    root.innerHTML = `
      <div class="modal" id="modal">
        <div class="box">
          <div style="font-weight:700">Input requested</div>
          <div style="margin-top:8px">${escapeHtml(promptText)}</div>
          <input id="modalInput" placeholder="Type here..." />
          <div style="display:flex; gap:8px; margin-top:10px;">
            <button class="btn" id="modalOk">OK</button>
            <button class="btn" id="modalCancel" style="background:#64748b">Cancel</button>
          </div>
        </div>
      </div>`;
    root.style.display = 'block';
    const modalInput = document.getElementById('modalInput');
    modalInput.focus();
    const cleanup = (value) => {
      root.style.display = 'none';
      root.innerHTML = '';
      resolve(value);
    };
    document.getElementById('modalOk').onclick = () => cleanup(modalInput.value);
    document.getElementById('modalCancel').onclick = () => cleanup('');
    modalInput.onkeydown = (e) => { if (e.key === 'Enter') cleanup(modalInput.value); };
  });
}

function escapeHtml(s) {
  if (!s && s !== 0) return '';
  return s.toString().replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

document.getElementById('run').onclick = async () => {
  let code = document.getElementById('code').value;
  document.getElementById('output').textContent = 'Preparing...';

  // Find put("...") occurrences (supports single or double quotes), left to right
  const putRegex = /put\s*\(\s*("(?:[^"\\]|\\.)*"|'(?:[^'\\]|\\.)*')\s*\)/g;
  const prompts = [];
  let match;
  while ((match = putRegex.exec(code)) !== null) {
    let raw = match[1];
    // strip quotes
    if ((raw.startsWith('"') && raw.endsWith('"')) || (raw.startsWith("'") && raw.endsWith("'"))) {
      raw = raw.slice(1, -1).replace(/\\(.)/g, '$1');
    }
    prompts.push({ fullMatch: match[0], question: raw });
  }

  // Ask prompts in sequence (if any)
  if (prompts.length > 0) {
    const answers = [];
    for (const p of prompts) {
      const ans = await showPrompt(p.question);
      answers.push(ans);
    }
    // replace each occurrence in order with a properly escaped string literal
    // Use global replace but replace one by one to avoid messing indexes
    for (let i = 0; i < prompts.length; i++) {
      const q = prompts[i];
      const escaped = escapeForCode(answers[i]);
      // replace first occurrence
      code = code.replace(q.fullMatch, escaped);
    }
  }

  // send code to server
  document.getElementById('output').textContent = 'Running...';
  try {
    const res = await fetch('/run', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ code })
    });
    const data = await res.json();
    if (data.ok) {
      document.getElementById('output').textContent = data.output || '(no output)';
    } else {
      document.getElementById('output').textContent = 'Error: ' + (data.error || 'unknown');
    }
  } catch (err) {
    document.getElementById('output').textContent = 'Network or server error: ' + err.message;
  }
};
</script>
</body>
</html>
